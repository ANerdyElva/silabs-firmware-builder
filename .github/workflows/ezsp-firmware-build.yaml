name: EmberZNet Zigbee firmware build

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/ezsp-firmware-build.yaml
  workflow_run:
    workflows:
      - "Silicon Labs build container image"
    branches:
      - main
    types:
      - completed

jobs:
  ezsp-firmware-build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nabucasa/silabs-firmware-builder:${{ matrix.sdk_version }}
      options: --user root
    strategy:
      matrix:
        sdk_version:
          - 4.1.4
        include:
          - firmware: ncp-uart-hw-yellow
            with: MGM210PA32JIA,simple_led:board_activity
            patchpath: "EmberZNet/Yellow"
          - firmware: ncp-uart-hw-skyconnect
            with: EFR32MG21A020F512IM32
            patchpath: "EmberZNet/SkyConnect"
    steps:
      - uses: actions/checkout@v3.3.0
      - name: Adjust permission
        run: chown builder .
      - name: Generate Firmware Project
        shell: su --shell=/bin/bash builder {0}
        run: |
          slc generate \
              --with="${{ matrix.with }}" \
              --project-file=/gecko_sdk/protocol/zigbee/app/ncp/sample-app/ncp-uart-hw/ncp-uart-hw.slcp \
              --export-destination=${{ matrix.firmware }} \
              --copy-proj-sources --new-project --force \
              --configuration=" \
                SL_IOSTREAM_USART_VCOM_RX_BUFFER_SIZE:64, \
                EMBER_APS_UNICAST_MESSAGE_COUNT:20, \
                EMBER_NEIGHBOR_TABLE_SIZE:26, \
                EMBER_SOURCE_ROUTE_TABLE_SIZE:200, \
                "
      - name: Patch Firmware
        shell: su --shell=/bin/bash builder {0}
        run: |
          cd ${{ matrix.firmware }}
          for patch in "../${{ matrix.patchpath }}"/*.patch
          do
              echo "Applying ${patch}"
              patch -p1 < $patch
          done

      - name: Build Firmware
        shell: su --shell=/bin/bash builder {0}
        run: |
          cd ${{ matrix.firmware }}
          make -f ncp-uart-hw.Makefile release
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.firmware }}
          path: ${{ matrix.firmware }}
